<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/static/favicon-dark.png">
    <title>Roster Management Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#0a0a0b',
                        foreground: '#fafafa',
                        muted: '#171717',
                        'muted-foreground': '#a1a1aa',
                        popover: '#0a0a0b',
                        'popover-foreground': '#fafafa',
                        card: '#0a0a0b',
                        'card-foreground': '#fafafa',
                        border: '#27272a',
                        input: '#27272a',
                        primary: '#3b82f6',
                        'primary-foreground': '#f8fafc',
                        secondary: '#27272a',
                        'secondary-foreground': '#fafafa',
                        accent: '#27272a',
                        'accent-foreground': '#fafafa',
                        destructive: '#dc2626',
                        'destructive-foreground': '#fafafa',
                        ring: '#3b82f6',
                    }
                }
            }
        }
    </script>

    <style>
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .tab-active {
            @apply bg-primary text-primary-foreground;
        }

        .tab-inactive {
            @apply text-muted-foreground hover:text-foreground hover:bg-accent;
        }

        .member-card {
            @apply bg-background border border-border rounded-md p-3 cursor-move select-none transition-all duration-200;
        }

        .member-card:hover {
            @apply border-primary shadow-md;
        }

        .member-card.dragging {
            @apply opacity-50 scale-95;
        }

        .drop-zone.drag-over {
            @apply border-primary border-solid bg-primary/5;
        }

        .autocomplete-item {
            @apply px-3 py-2 hover:bg-accent cursor-pointer transition-colors;
        }

        .autocomplete-item:hover {
            @apply bg-accent text-accent-foreground;
        }

        /* Table-specific styles */
        .member-table {
            @apply w-full border-collapse;
            min-width: 100%;
        }
        
        .member-table th,
        .member-table td {
            @apply whitespace-nowrap text-center;
            min-width: 120px;
        }

        .member-row.dragging {
            @apply opacity-50;
        }

        .group-separator td {
            @apply bg-muted/30 border-y border-border;
        }

        .member-table th {
            @apply text-left text-xs font-medium text-muted-foreground px-3 py-2 bg-muted/20;
        }

        .member-table tbody td {
            @apply border-b border-border/50;
        }
        
        .member-table tbody td:not([class*="px-"]) {
            @apply px-3 py-2 text-xs;
        }

        .empty-drop-row {
            @apply min-h-16;
        }

        .empty-drop-row.drag-over {
            @apply border-primary bg-primary/10;
        }
    </style>
</head>

<body class="bg-background text-foreground min-h-screen">
<div class="flex h-[calc(100vh-80px)]">
    <!-- Sidebar -->
    <div class="w-80 border-r border-border bg-card p-6 space-y-6">
        <!-- Sidebar Header with Logo -->
        <div class="flex items-center gap-3 pb-4 border-b border-border">
            <div class="w-10 h-10 rounded-lg border border-border bg-muted flex items-center justify-center">
                <img src="/static/favicon-dark.png" alt="ClashKing Logo" class="w-6 h-6"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                <i data-lucide="shield" class="w-5 h-5 text-muted-foreground" style="display: none;"></i>
            </div>
            <div>
                <h2 class="font-semibold">Roster Management</h2>
                <p class="text-xs text-muted-foreground">Configure your rosters</p>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alerts" class="space-y-3"></div>

        <!-- Roster Selection -->
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <label class="text-sm font-medium">Active Roster</label>
                <button onclick="showCreateRosterModal()"
                        class="p-1 hover:bg-accent rounded text-muted-foreground hover:text-foreground"
                        title="Create New Roster">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <select id="roster-selector" onchange="selectRoster()"
                    class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                <option value="">Choose a roster...</option>
                {% for roster in all_rosters %}
                    <option value="{{ roster.custom_id }}"
                            {% if roster.custom_id == current_roster.custom_id %}selected{% endif %}>
                        {{ roster.alias }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Navigation Tabs -->
        <nav class="space-y-1">
            <!-- Roster Specific Tabs -->
            <div id="roster-tabs" class="space-y-1" {% if not current_roster %}style="display: none"{% endif %}>
                <div class="text-xs font-medium text-muted-foreground uppercase tracking-wide px-2 py-1">
                    Roster Management
                </div>

                <button onclick="showTab('settings')" id="tab-settings"
                        class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors tab-active">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span>Settings</span>
                </button>

                <button onclick="showTab('members')" id="tab-members"
                        class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors tab-inactive">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>Members</span>
                    <span class="ml-auto bg-muted text-muted-foreground px-1.5 py-0.5 rounded text-xs"
                          id="sidebar-member-count">{{ (current_roster.members|length) if current_roster.members else 0 }}</span>
                </button>
            </div>

            <!-- Global Management Section -->
            <div class="pt-4 space-y-1">
                <div class="text-xs font-medium text-muted-foreground uppercase tracking-wide px-2 py-1">
                    Global Management
                </div>

                <button onclick="showTab('groups')" id="tab-groups"
                        class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors tab-inactive">
                    <i data-lucide="folder" class="w-4 h-4"></i>
                    <span>Groups</span>
                    <span class="ml-auto bg-muted text-muted-foreground px-1.5 py-0.5 rounded text-xs">{{ groups|length }}</span>
                </button>

                <button onclick="showTab('categories')" id="tab-categories"
                        class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors tab-inactive">
                    <i data-lucide="tags" class="w-4 h-4"></i>
                    <span>Categories</span>
                    <span class="ml-auto bg-muted text-muted-foreground px-1.5 py-0.5 rounded text-xs">{{ categories|length }}</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-auto">
        <div class="p-8">

            <!-- Welcome/No Selection State -->
            <div id="welcome-content" {% if current_roster %}style="display: none"{% endif %}>
                <div class="text-center py-16">
                    <i data-lucide="arrow-left" class="w-16 h-16 mx-auto text-muted-foreground mb-6"></i>
                    <h2 class="text-xl font-semibold mb-2">Select a Roster</h2>
                    <p class="text-muted-foreground mb-6">Choose a roster from the sidebar to start managing it</p>
                    <button onclick="showCreateRosterModal()"
                            class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors flex items-center gap-2 mx-auto">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Create Your First Roster
                    </button>
                </div>
            </div>

            <!-- Settings Tab Content -->
            <div id="content-settings" class="tab-content" {% if not current_roster %}style="display: none"{% endif %}>
                <div class="max-w-4xl">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-2">Roster Settings</h2>
                        <p class="text-muted-foreground">Configure your roster properties and requirements</p>
                    </div>

                    <div class="bg-card border border-border rounded-lg">
                        <form id="roster-form" class="p-6 space-y-8">
                            <!-- Basic Information -->
                            <div class="space-y-4">
                                <h3 class="font-medium text-sm text-muted-foreground uppercase tracking-wide">Basic
                                    Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Roster Name</label>
                                        <input type="text" name="alias"
                                               value="{{ current_roster.alias if current_roster else '' }}"
                                               class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent"
                                               required>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Roster Size</label>
                                        <input type="number" name="roster_size"
                                               value="{{ current_roster.roster_size or '' if current_roster else '' }}"
                                               class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent"
                                               min="1">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">Description</label>
                                    <textarea name="description" rows="3"
                                              class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent resize-none">{{ current_roster.description or '' if current_roster else '' }}</textarea>
                                </div>
                            </div>

                            <!-- Group Assignment -->
                            <div class="space-y-4">
                                <h3 class="font-medium text-sm text-muted-foreground uppercase tracking-wide">Group
                                    Assignment</h3>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">Roster Group</label>
                                    <select name="group_id"
                                            class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                                        <option value="">No group assigned</option>
                                        {% for group in groups %}
                                            <option value="{{ group._id }}"
                                                    {% if current_roster and current_roster.group_id == group._id %}selected{% endif %}>
                                                {{ group.alias }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <p class="text-xs text-muted-foreground">Groups help organize rosters for bulk
                                        operations</p>
                                </div>
                            </div>

                            <!-- Organization & Permissions -->
                            <div class="space-y-4">
                                <h3 class="font-medium text-sm text-muted-foreground uppercase tracking-wide">
                                    Organization & Permissions</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Organization Type</label>
                                        <select name="roster_type" onchange="toggleClanSelection()"
                                                class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                                            <option value="clan"
                                                    {% if current_roster and current_roster.roster_type == 'clan' %}selected{% endif %}>
                                                Clan-specific
                                            </option>
                                            <option value="family"
                                                    {% if current_roster and current_roster.roster_type == 'family' %}selected{% endif %}>
                                                Family-wide
                                            </option>
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Signup Permissions</label>
                                        <select name="signup_scope"
                                                class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                                            <option value="clan-only"
                                                    {% if current_roster and current_roster.signup_scope == 'clan-only' %}selected{% endif %}>
                                                Clan members only
                                            </option>
                                            <option value="family-wide"
                                                    {% if current_roster and current_roster.signup_scope == 'family-wide' %}selected{% endif %}>
                                                Family members
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div id="clan-selection" class="space-y-2">
                                    <label class="text-sm font-medium">Associated Clan</label>
                                    <select name="clan_tag" id="clan-select"
                                            class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                                        <option value="">Select a clan...</option>
                                        {% for clan in server_clans %}
                                            <option value="{{ clan.tag }}"
                                                    {% if current_roster and current_roster.clan_tag == clan.tag %}selected{% endif %}>
                                                {{ clan.name }} ({{ clan.tag }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Requirements -->
                            <div class="space-y-4">
                                <h3 class="font-medium text-sm text-muted-foreground uppercase tracking-wide">
                                    Requirements</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Min Town Hall</label>
                                        <select name="min_th"
                                                class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                                            <option value="">No minimum</option>
                                            {% for th in range(1, 18) %}
                                                <option value="{{ th }}"
                                                        {% if current_roster and current_roster.min_th == th %}selected{% endif %}>
                                                    TH {{ th }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Max Town Hall</label>
                                        <select name="max_th"
                                                class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                                            <option value="">No maximum</option>
                                            {% for th in range(1, 18) %}
                                                <option value="{{ th }}"
                                                        {% if current_roster and current_roster.max_th == th %}selected{% endif %}>
                                                    TH {{ th }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Max Accounts/User</label>
                                        <input type="number" name="max_accounts_per_user"
                                               value="{{ current_roster.max_accounts_per_user or '' if current_roster else '' }}"
                                               class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent"
                                               min="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Allowed Categories -->
                            <div class="space-y-4">
                                <h3 class="font-medium text-sm text-muted-foreground uppercase tracking-wide">Allowed
                                    Categories</h3>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">Member Categories</label>
                                    <div id="categories-checkboxes">
                                        {% if categories %}
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                {% for category in categories %}
                                                    <label class="flex items-center gap-2 p-2 border border-border rounded cursor-pointer hover:bg-accent">
                                                        <input type="checkbox" name="allowed_signup_categories"
                                                               value="{{ category.custom_id }}"
                                                               {% if current_roster and current_roster.allowed_signup_categories and category.custom_id in current_roster.allowed_signup_categories %}checked{% endif %}
                                                               class="rounded border-border text-primary focus:ring-primary">
                                                        <span class="text-sm">{{ category.alias }}</span>
                                                    </label>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="p-4 border border-border rounded-md text-center">
                                                <p class="text-sm text-muted-foreground mb-2">No categories
                                                    available</p>
                                                <button type="button" onclick="showTab('categories')"
                                                        class="text-sm text-primary hover:underline">
                                                    Create categories in Global Management
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex justify-end pt-6 border-t border-border">
                                <button type="submit"
                                        class="px-6 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90 transition-colors flex items-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Members Tab Content -->
            <div id="content-members" class="tab-content hidden">
                <div class="max-w-7xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold mb-2">Members</h2>
                            <p class="text-muted-foreground">Manage roster members with drag & drop categorization</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="refreshMembers()"
                                    class="px-3 py-1.5 bg-secondary text-secondary-foreground rounded-md text-sm hover:bg-secondary/80 transition-colors flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Column Configuration -->
                    <div class="bg-card border border-border rounded-lg mb-6">
                        <button type="button" onclick="toggleDisplayConfig()" class="w-full p-6 text-left flex items-center justify-between hover:bg-accent/50 transition-colors">
                            <div class="flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                <h3 class="font-medium">Display Configuration</h3>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 transform transition-transform" id="display-config-chevron"></i>
                        </button>
                        <div id="display-config-content" class="hidden px-6 pb-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Column Selection -->
                            <div>
                                <label class="text-sm font-medium mb-2 block">Display Columns (in order)</label>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs text-muted-foreground">Column 1</label>
                                        <select id="column-1" name="column-1" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="">None</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="discord">Discord User</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="war_pref">War Opt Status</option>
                                            <option value="trophies">Trophies</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-muted-foreground">Column 2</label>
                                        <select id="column-2" name="column-2" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="">None</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="discord">Discord User</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="war_pref">War Opt Status</option>
                                            <option value="trophies">Trophies</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-muted-foreground">Column 3</label>
                                        <select id="column-3" name="column-3" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="">None</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="discord">Discord User</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="war_pref">War Opt Status</option>
                                            <option value="trophies">Trophies</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-muted-foreground">Column 4</label>
                                        <select id="column-4" name="column-4" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="">None</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="discord">Discord User</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="war_pref">War Opt Status</option>
                                            <option value="trophies">Trophies</option>
                                        </select>
                                    </div>
                                </div>
                                <p class="text-xs text-muted-foreground mt-2">Choose up to 4 columns in display order</p>
                            </div>
                            
                            <!-- Sort Configuration -->
                            <div>
                                <label class="text-sm font-medium mb-2 block">Member Sort Order (by preference, all ascending)</label>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs text-muted-foreground">1st Priority</label>
                                        <select id="sort-1" name="sort-1" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="trophies">Trophies</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="added_at">Date Added</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-muted-foreground">2nd Priority</label>
                                        <select id="sort-2" name="sort-2" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="">None</option>
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="trophies">Trophies</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="added_at">Date Added</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-muted-foreground">3rd Priority</label>
                                        <select id="sort-3" name="sort-3" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="">None</option>
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="trophies">Trophies</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="added_at">Date Added</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-muted-foreground">4th Priority</label>
                                        <select id="sort-4" name="sort-4" class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm">
                                            <option value="">None</option>
                                            <option value="name">Name</option>
                                            <option value="tag">Player Tag</option>
                                            <option value="townhall">Townhall Level</option>
                                            <option value="hero_lvs">Heroes</option>
                                            <option value="trophies">Trophies</option>
                                            <option value="hitrate">30 Day Hitrate</option>
                                            <option value="current_clan_tag">Clan Tag</option>
                                            <option value="added_at">Date Added</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end mt-4 pt-4 border-t border-border">
                            <button onclick="saveDisplayConfiguration()" 
                                    class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors flex items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                Save Configuration
                            </button>
                        </div>
                        </div>
                    </div>

                    <!-- Add Member Search -->
                    <div class="bg-card border border-border rounded-lg p-6 mb-6">
                        <h3 class="font-medium mb-4 flex items-center gap-2">
                            <i data-lucide="search" class="w-4 h-4"></i>
                            Add Members
                        </h3>

                        <!-- Search Input -->
                        <div class="flex gap-4 mb-4">
                            <div class="flex-1 relative">
                                <input type="text" id="member-search"
                                       placeholder="Search by name or enter player tag..."
                                       class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent"
                                       oninput="searchMembers(this.value)" onkeypress="handleSearchKeypress(event)">
                                <div id="member-suggestions"
                                     class="absolute top-full left-0 right-0 bg-card border border-border rounded-md mt-1 max-h-60 overflow-y-auto z-10 hidden">
                                    <!-- Autocomplete suggestions will appear here -->
                                </div>
                            </div>
                            <div class="w-48">
                                <select id="category-selector"
                                        class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                                    <option value="">No category</option>
                                    {% for category in categories %}
                                        <option value="{{ category.custom_id }}">{{ category.alias }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button onclick="addMemberDirectly()"
                                    class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors flex items-center gap-2">
                                <i data-lucide="user-plus" class="w-4 h-4"></i>
                                Add Member
                            </button>
                        </div>

                        <!-- Bulk Add Section -->
                        <div class="mb-4">
                            <button onclick="toggleBulkAdd()" id="bulk-add-toggle"
                                    class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 mb-2">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                                Bulk add multiple tags
                                <i data-lucide="chevron-down" class="w-4 h-4" id="bulk-add-chevron"></i>
                            </button>
                            <div id="bulk-add-section" class="hidden">
                                <div class="border border-border rounded-md p-3 bg-muted/30">
                                    <textarea id="bulk-tags-input"
                                              placeholder="Paste player tags here, one per line or separated by commas/spaces:&#10;#ABC123&#10;#DEF456&#10;#GHI789"
                                              class="w-full h-24 px-3 py-2 bg-background border border-input rounded-md text-sm resize-none focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent"
                                              oninput="validateBulkTags()"></textarea>
                                    <div class="flex justify-between items-center mt-2">
                                        <span id="bulk-tags-count" class="text-sm text-muted-foreground">0 tags detected</span>
                                        <div class="flex gap-2">
                                            <button onclick="clearBulkTags()"
                                                    class="px-3 py-1 text-xs text-muted-foreground hover:text-foreground">
                                                Clear
                                            </button>
                                            <button onclick="addBulkMembers()"
                                                    id="bulk-add-button"
                                                    class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    disabled>
                                                <i data-lucide="users" class="w-4 h-4"></i>
                                                Add All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Category-specific members -->
                    <div id="category-sections">
                        {% for category in categories %}
                            <div class="bg-card border border-border rounded-lg"
                                 data-category="{{ category.custom_id }}">
                                <div class="p-4 border-b border-border">
                                    <h3 class="font-medium flex items-center gap-2">
                                        <i data-lucide="tag" class="w-4 h-4"></i>
                                        {{ category.alias }}
                                        <span class="ml-auto bg-primary/10 text-primary px-2 py-1 rounded text-xs category-count"
                                              id="count-{{ category.custom_id }}">0</span>
                                    </h3>
                                </div>
                                <div class="p-4">
                                    <div id="category-{{ category.custom_id }}"
                                         class="drop-zone grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 min-h-[100px] border-2 border-dashed border-muted rounded-lg p-3"
                                         ondrop="drop(event, '{{ category.custom_id }}')" ondragover="allowDrop(event)">
                                        <!-- Member cards will appear here -->
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Members by Category -->
                    <div class="grid gap-6" id="member-categories">
                        <!-- Uncategorized Members -->
                        <div class="bg-card border border-border rounded-lg">
                            <div class="p-4 border-b border-border">
                                <h3 class="font-medium text-muted-foreground flex items-center gap-2">
                                    <i data-lucide="users" class="w-4 h-4"></i>
                                    Uncategorized
                                    <span class="ml-auto bg-muted text-muted-foreground px-2 py-1 rounded text-xs"
                                          id="uncategorized-count">0</span>
                                </h3>
                            </div>
                            <div class="p-4">
                                <div id="uncategorized-members"
                                     class="drop-zone grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 min-h-[100px] border-2 border-dashed border-muted rounded-lg p-3"
                                     ondrop="drop(event, null)" ondragover="allowDrop(event)">
                                    <!-- Member cards will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Empty state -->
                        <div id="members-empty-state" class="bg-card border border-border rounded-lg p-12 text-center"
                             style="display: none;">
                            <i data-lucide="user-plus" class="w-16 h-16 mx-auto text-muted-foreground mb-6"></i>
                            <h3 class="text-lg font-medium text-muted-foreground mb-2">No members yet</h3>
                            <p class="text-sm text-muted-foreground mb-6">Start building your roster by searching and
                                adding members above</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Groups Tab Content -->
            <div id="content-groups" class="tab-content hidden">
                <div class="max-w-4xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold mb-2">Roster Groups</h2>
                            <p class="text-muted-foreground">Organize rosters into groups for bulk operations</p>
                        </div>
                        <button onclick="showCreateGroupModal()"
                                class="px-3 py-1.5 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            New Group
                        </button>
                    </div>

                    {% if groups %}
                        <div class="space-y-3">
                            {% for group in groups %}
                                <div class="bg-card border border-border rounded-lg p-6">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="font-semibold text-lg">{{ group.alias }}</h3>
                                            <p class="text-sm text-muted-foreground mt-1">
                                                Max accounts per user: {{ group.max_accounts_per_user or 'No limit' }}
                                            </p>
                                        </div>
                                        <button onclick="deleteGroup('{{ group._id }}')"
                                                class="px-3 py-1.5 bg-destructive/10 text-destructive rounded-md text-sm hover:bg-destructive/20 transition-colors">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="bg-card border border-border rounded-lg p-12 text-center">
                            <i data-lucide="folder" class="w-16 h-16 mx-auto text-muted-foreground mb-6"></i>
                            <h3 class="text-lg font-medium text-muted-foreground mb-2">No groups created</h3>
                            <p class="text-sm text-muted-foreground mb-6">Create groups to organize your rosters for
                                bulk operations</p>
                            <button onclick="showCreateGroupModal()"
                                    class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors">
                                Create First Group
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Categories Tab Content -->
            <div id="content-categories" class="tab-content hidden">
                <div class="max-w-4xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold mb-2">Signup Categories</h2>
                            <p class="text-muted-foreground">Define member signup categories for rosters</p>
                        </div>
                        <button onclick="showCreateCategoryModal()"
                                class="px-3 py-1.5 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            New Category
                        </button>
                    </div>

                    {% if categories %}
                        <div class="space-y-3">
                            {% for category in categories %}
                                <div class="bg-card border border-border rounded-lg p-6">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="font-semibold text-lg">{{ category.alias }}</h3>
                                            <p class="text-sm text-muted-foreground font-mono mt-1">{{ category.custom_id }}</p>
                                        </div>
                                        <button onclick="deleteCategory('{{ category.custom_id }}')"
                                                class="px-3 py-1.5 bg-destructive/10 text-destructive rounded-md text-sm hover:bg-destructive/20 transition-colors">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="bg-card border border-border rounded-lg p-12 text-center">
                            <i data-lucide="tags" class="w-16 h-16 mx-auto text-muted-foreground mb-6"></i>
                            <h3 class="text-lg font-medium text-muted-foreground mb-2">No categories created</h3>
                            <p class="text-sm text-muted-foreground mb-6">Create categories to organize member signups
                                across your rosters</p>
                            <button onclick="showCreateCategoryModal()"
                                    class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors">
                                Create First Category
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden" onclick="closeModals()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-card border border-border rounded-lg max-w-md w-full p-6" onclick="event.stopPropagation()">


            <!-- Create Group Modal -->
            <div id="create-group-modal" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="folder-plus" class="w-5 h-5"></i>
                    <h3 class="font-semibold">Create Group</h3>
                </div>
                <form id="create-group-form" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Group Name</label>
                        <input type="text" name="alias" required maxlength="64" placeholder="Enter group name"
                               class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModals()"
                                class="px-3 py-1.5 bg-secondary text-secondary-foreground rounded-md text-sm hover:bg-secondary/80">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-3 py-1.5 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90">
                            Create
                        </button>
                    </div>
                </form>
            </div>

            <!-- Create Category Modal -->
            <div id="create-category-modal" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="tag" class="w-5 h-5"></i>
                    <h3 class="font-semibold">Create Category</h3>
                </div>
                <form id="create-category-form" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Category Name</label>
                        <input type="text" name="alias" required maxlength="32"
                               placeholder="e.g., Main Roster, Backup, TH15+"
                               class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                        <p class="text-xs text-muted-foreground">The system will automatically generate a unique ID</p>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModals()"
                                class="px-3 py-1.5 bg-secondary text-secondary-foreground rounded-md text-sm hover:bg-secondary/80">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-3 py-1.5 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90">
                            Create
                        </button>
                    </div>
                </form>
            </div>

            <!-- Create Roster Modal -->
            <div id="create-roster-modal" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <h3 class="font-semibold">Create Roster</h3>
                </div>
                <form id="create-roster-form" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Roster Name</label>
                        <input type="text" name="alias" required maxlength="64"
                               placeholder="e.g., CWL Main, War Backup, Push Team"
                               class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium">Organization Type</label>
                        <select name="roster_type" onchange="toggleCreateClanSelection()" required
                                class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                            <option value="clan">Clan-specific</option>
                            <option value="family">Family-wide</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium">Signup Permissions</label>
                        <select name="signup_scope" required
                                class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                            <option value="clan-only">Clan members only</option>
                            <option value="family-wide">Family members</option>
                        </select>
                    </div>

                    <div id="create-clan-selection" class="space-y-2">
                        <label class="text-sm font-medium">Associated Clan</label>
                        <select name="clan_tag" id="create-clan-select" required
                                class="w-full px-3 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent">
                            <option value="">Select a clan...</option>
                            {% for clan in server_clans %}
                                <option value="{{ clan.tag }}">{{ clan.name }} ({{ clan.tag }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModals()"
                                class="px-3 py-1.5 bg-secondary text-secondary-foreground rounded-md text-sm hover:bg-secondary/80">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-3 py-1.5 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90">
                            Create Roster
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    lucide.createIcons();

    const API_BASE = '/v2';
    const ROSTER_TOKEN = new URLSearchParams(window.location.search).get('token');
    let currentRosterId = '{{ current_roster.custom_id if current_roster else '' }}';
    let currentRosterData = {{ current_roster_json | safe }};
    const serverId = '{{ server_id }}';
    const categoriesData = {{ categories_json | safe }};

    // Tab navigation
    function showTab(tabName) {
        // Update sidebar tabs
        document.querySelectorAll('[id^="tab-"]').forEach(tab => {
            tab.classList.remove('tab-active');
            tab.classList.add('tab-inactive');
        });

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        // Show selected tab
        document.getElementById('tab-' + tabName).classList.remove('tab-inactive');
        document.getElementById('tab-' + tabName).classList.add('tab-active');
        document.getElementById('content-' + tabName).classList.remove('hidden');
        
        // Save current tab to localStorage
        localStorage.setItem('roster-current-tab', tabName);
        
        // If switching to members tab, reload the form data to populate dropdowns
        if (tabName === 'members' && currentRosterData) {
            console.log('Switching to members tab, reloading form data...');
            setTimeout(() => {
                updateSettingsForm(currentRosterData);
                populateCategoryDropdown(); // Ensure category dropdown is populated
            }, 100);
        }
    }

    // Roster selection
    async function selectRoster() {
        const selectedId = document.getElementById('roster-selector').value;

        if (!selectedId) {
            // Update URL to remove roster_id
            const url = new URL(window.location);
            url.searchParams.delete('roster_id');
            window.history.pushState({}, '', url);

            document.getElementById('roster-tabs').style.display = 'none';
            document.getElementById('welcome-content').style.display = 'block';
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            currentRosterId = '';
            return;
        }

        // If it's the same roster, just show the UI
        if (selectedId === currentRosterId) {
            showRosterUI();
            return;
        }

        // Update URL with new roster_id
        const url = new URL(window.location);
        url.searchParams.set('roster_id', selectedId);
        window.history.pushState({}, '', url);

        // Load new roster data
        try {
            const response = await apiCall(`${API_BASE}/roster/${selectedId}?server_id=${serverId}`, 'GET');
            const roster = response.roster;

            // Update current roster ID and data
            currentRosterId = selectedId;
            currentRosterData = roster;

            // Update UI with new roster data
            updateRosterUI(roster);
            showRosterUI();
        } catch (error) {
            showAlert('Failed to load roster data', 'error');
            // Reset selector to previous value
            document.getElementById('roster-selector').value = currentRosterId;
            // Revert URL
            const url = new URL(window.location);
            if (currentRosterId) url.searchParams.set('roster_id', currentRosterId);
            else url.searchParams.delete('roster_id');
            window.history.pushState({}, '', url);
        }


    }

    function showRosterUI() {
        document.getElementById('roster-tabs').style.display = 'block';
        document.getElementById('welcome-content').style.display = 'none';

        // Show last active tab or default to settings
        const savedTab = localStorage.getItem('roster-current-tab') || 'settings';
        showTab(savedTab);
    }

    function updateRosterUI(roster) {
        try {

            // Update form fields in settings
            updateSettingsForm(roster);

            // Update members table
            updateMembersTable(roster);

            // Load members display for drag & drop interface
            loadMembersDisplay();
        } catch (error) {
            console.error('Error updating roster UI:', error);
        }
    }

    function updateSettingsForm(roster) {
        const form = document.getElementById('roster-form');
        if (!form) return;
        
        console.log('updateSettingsForm called with roster:', roster);

        // Update form fields
        form.elements['alias'].value = roster.alias || '';
        form.elements['roster_size'].value = roster.roster_size || '';
        form.elements['description'].value = roster.description || '';
        form.elements['roster_type'].value = roster.roster_type || 'clan';
        form.elements['signup_scope'].value = roster.signup_scope || 'clan-only';
        form.elements['clan_tag'].value = roster.clan_tag || '';
        form.elements['min_th'].value = roster.min_th || '';
        form.elements['max_th'].value = roster.max_th || '';
        form.elements['max_accounts_per_user'].value = roster.max_accounts_per_user || '';
        form.elements['group_id'].value = roster.group_id || '';

        // Update allowed categories checkboxes
        const categoryCheckboxes = form.querySelectorAll('input[name="allowed_signup_categories"]');
        categoryCheckboxes.forEach(cb => {
            cb.checked = roster.allowed_signup_categories && roster.allowed_signup_categories.includes(cb.value);
        });

        // Update display columns dropdowns
        const displayColumns = roster.columns || ['Name', 'Player Tag', 'Townhall Level', '30 Day Hitrate'];
        
        console.log('Loading roster columns:', displayColumns);
        
        // Convert display names back to values
        const reverseColumnMapping = {
            'Townhall Level': 'townhall',
            'Name': 'name',
            'Player Tag': 'tag',
            '30 Day Hitrate': 'hitrate',
            'Clan Tag': 'current_clan_tag',
            'Discord User': 'discord',
            'Heroes': 'hero_lvs',
            'War Opt Status': 'war_pref',
            'Trophies': 'trophies'
        };
        
        // Populate column selectors
        for (let i = 1; i <= 4; i++) {
            const element = form.elements[`column-${i}`] || document.getElementById(`column-${i}`);
            if (element) {
                const displayName = displayColumns[i - 1] || '';
                const mappedValue = reverseColumnMapping[displayName] || '';
                element.value = mappedValue;
            } else {
                console.warn(`Element column-${i} not found!`);
            }
        }

        // Update sort configuration
        const sortConfig = roster.sort || ['Name', 'Player Tag', 'Heroes', 'Townhall Level'];
        
        console.log('Loading roster sort:', sortConfig);
        
        // Convert sort display names back to values
        const reverseSortMapping = {
            'Name': 'name',
            'Player Tag': 'tag',
            'Townhall Level': 'townhall',
            'Heroes': 'hero_lvs',
            'Trophies': 'trophies',
            '30 Day Hitrate': 'hitrate',
            'Clan Tag': 'current_clan_tag',
            'Date Added': 'added_at'
        };
        
        // Update sort selectors
        for (let i = 1; i <= 4; i++) {
            const element = form.elements[`sort-${i}`] || document.getElementById(`sort-${i}`);
            if (element) {
                const displayName = sortConfig[i - 1] || '';
                const mappedValue = reverseSortMapping[displayName] || '';
                element.value = mappedValue;
            } else {
                console.warn(`Element sort-${i} not found!`);
            }
        }

        // Update clan selection requirements
        toggleClanSelection();
    }

    function updateMembersTable(roster) {
        // Update sidebar member count
        const sidebarCount = document.getElementById('sidebar-member-count');
        if (sidebarCount) {
            sidebarCount.textContent = roster.members?.length || 0;
        }

        // Load the new drag & drop interface
        loadMembersDisplay();
    }

    // Clan selection toggle
    function toggleClanSelection() {
        const rosterType = document.querySelector('select[name="roster_type"]').value;
        const clanSelect = document.getElementById('clan-select');
        const label = document.querySelector('#clan-selection label');

        if (rosterType === 'family') {
            clanSelect.removeAttribute('required');
            label.textContent = 'Reference Clan (optional)';
        } else {
            clanSelect.setAttribute('required', 'required');
            label.textContent = 'Associated Clan';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function () {
        lucide.createIcons();
        toggleClanSelection();

        // Ensure category dropdown is populated
        
        // Populate dropdown with JavaScript if needed
        populateCategoryDropdown();

        // Load clan members for autocomplete
        await loadClanMembers();

        // Add event listeners for column selection
        ['column-1', 'column-2', 'column-3', 'column-4'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', function(event) {
                    event.preventDefault();
                    handleColumnChange(event);
                    return false;
                });
            }
        });

        // Add event listeners for sort configuration changes
        ['sort-1', 'sort-2', 'sort-3', 'sort-4'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', function(event) {
                    event.preventDefault();
                    updateMemberCardsPreview();
                    return false;
                });
            }
        });

        // Show appropriate initial state
        
        if (currentRosterId) {
            selectRoster();
            // Also load members display for initial roster
            setTimeout(() => loadMembersDisplay(), 100);
        } else if (currentRosterData) {
            // If we have roster data but no ID (shouldn't happen), still try to populate
            updateSettingsForm(currentRosterData);
        }
    });

    // Notifications (alias for showAlert)
    function showNotification(message, type = 'success') {
        showAlert(message, type);
    }

    // Alerts
    function showAlert(message, type = 'success') {
        const alertsContainer = document.getElementById('alerts');
        const alertDiv = document.createElement('div');

        let bgColor, icon;
        switch (type) {
            case 'error':
                bgColor = 'bg-destructive/10 border-destructive/20 text-destructive';
                icon = 'alert-circle';
                break;
            case 'info':
                bgColor = 'bg-blue-500/10 border-blue-500/20 text-blue-400';
                icon = 'info';
                break;
            default:
                bgColor = 'bg-primary/10 border-primary/20 text-primary';
                icon = 'check-circle';
        }

        alertDiv.className = `flex items-center gap-2 p-3 rounded-lg border ${bgColor}`;
        alertDiv.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i><span class="text-sm font-medium">${message}</span>`;

        alertsContainer.appendChild(alertDiv);
        lucide.createIcons();

        // Auto-remove after 5 seconds, except for info messages which remove after 3 seconds
        const timeout = type === 'info' ? 3000 : 5000;
        setTimeout(() => alertDiv.remove(), timeout);
    }

    // API calls
    async function apiCall(endpoint, method = 'GET', data = null) {

        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${ROSTER_TOKEN}`
            }
        };

        if (data) options.body = JSON.stringify(data);

        try {
            const response = await fetch(endpoint, options);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    // Refresh functions
    async function refreshCategoriesList() {
        try {
            // Get updated categories from API
            const response = await apiCall(`${API_BASE}/roster-signup-category/list?server_id=${serverId}`, 'GET');
            const categories = response.items || [];

            // Update categories tab content
            updateCategoriesTab(categories);

            // Update the categories checkboxes in roster settings if they exist
            updateCategoriesCheckboxes(categories);

            // Update the tab counter
            const tabCounter = document.querySelector('#tab-categories .ml-auto');
            if (tabCounter) {
                tabCounter.textContent = categories.length;
            }

        } catch (error) {
            console.error('Failed to refresh categories:', error);
        }
    }

    function updateCategoriesTab(categories) {
        const contentCategories = document.getElementById('content-categories');
        if (!contentCategories) return;

        const categoriesContainer = contentCategories.querySelector('.max-w-4xl > div:last-child');
        if (!categoriesContainer) return;

        if (categories.length === 0) {
            // Show empty state
            categoriesContainer.innerHTML = `
                <div class="bg-card border border-border rounded-lg p-12 text-center">
                    <i data-lucide="tags" class="w-16 h-16 mx-auto text-muted-foreground mb-6"></i>
                    <h3 class="text-lg font-medium text-muted-foreground mb-2">No categories created</h3>
                    <p class="text-sm text-muted-foreground mb-6">Create categories to organize member signups across your rosters</p>
                    <button onclick="showCreateCategoryModal()" class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm hover:bg-primary/90 transition-colors">
                        Create First Category
                    </button>
                </div>
            `;
        } else {
            // Show categories list
            let categoriesHTML = '<div class="space-y-3">';
            categories.forEach(category => {
                categoriesHTML += `
                    <div class="bg-card border border-border rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-lg">${category.alias}</h3>
                                <p class="text-sm text-muted-foreground font-mono mt-1">${category.custom_id}</p>
                            </div>
                            <button onclick="deleteCategory('${category.custom_id}')" class="px-3 py-1.5 bg-destructive/10 text-destructive rounded-md text-sm hover:bg-destructive/20 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            categoriesHTML += '</div>';
            categoriesContainer.innerHTML = categoriesHTML;
        }

        // Recreate icons
        lucide.createIcons();
    }

    function updateCategoriesCheckboxes(categories) {
        const checkboxContainer = document.querySelector('#categories-checkboxes');
        if (!checkboxContainer) return;

        if (categories.length === 0) {
            checkboxContainer.innerHTML = `
                <div class="p-4 border border-border rounded-md text-center">
                    <p class="text-sm text-muted-foreground mb-2">No categories available</p>
                    <button type="button" onclick="showTab('categories')" class="text-sm text-primary hover:underline">
                        Create categories in Global Management
                    </button>
                </div>
            `;
        } else {
            let checkboxesHTML = '<div class="grid grid-cols-2 md:grid-cols-3 gap-2">';
            categories.forEach(category => {
                checkboxesHTML += `
                    <label class="flex items-center gap-2 p-2 border border-border rounded cursor-pointer hover:bg-accent">
                        <input type="checkbox" name="allowed_signup_categories" value="${category.custom_id}" 
                               class="rounded border-border text-primary focus:ring-primary">
                        <span class="text-sm">${category.alias}</span>
                    </label>
                `;
            });
            checkboxesHTML += '</div>';
            checkboxContainer.innerHTML = checkboxesHTML;
        }
    }

    // Modals

    function showCreateGroupModal() {
        document.getElementById('modal-overlay').classList.remove('hidden');
        document.querySelectorAll('#modal-overlay [id$="-modal"]').forEach(m => m.classList.add('hidden'));
        document.getElementById('create-group-modal').classList.remove('hidden');
    }

    function showCreateCategoryModal() {
        document.getElementById('modal-overlay').classList.remove('hidden');
        document.querySelectorAll('#modal-overlay [id$="-modal"]').forEach(m => m.classList.add('hidden'));
        document.getElementById('create-category-modal').classList.remove('hidden');
    }

    function showCreateRosterModal() {
        document.getElementById('modal-overlay').classList.remove('hidden');
        document.querySelectorAll('#modal-overlay [id$="-modal"]').forEach(m => m.classList.add('hidden'));
        document.getElementById('create-roster-modal').classList.remove('hidden');

        // Initialize clan selection toggle
        toggleCreateClanSelection();
    }

    // Clan selection toggle for create modal
    function toggleCreateClanSelection() {
        const rosterType = document.querySelector('#create-roster-modal select[name="roster_type"]').value;
        const clanSelect = document.getElementById('create-clan-select');
        const label = document.querySelector('#create-clan-selection label');

        if (rosterType === 'family') {
            clanSelect.removeAttribute('required');
            label.textContent = 'Reference Clan (optional)';
        } else {
            clanSelect.setAttribute('required', 'required');
            label.textContent = 'Associated Clan';
        }
    }

    function closeModals() {
        document.getElementById('modal-overlay').classList.add('hidden');
    }

    // Forms
    document.getElementById('roster-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentRosterId) {
            showAlert('Please select a roster first', 'error');
            return;
        }

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        // Process allowed_signup_categories checkboxes
        const categoryCheckboxes = e.target.querySelectorAll('input[name="allowed_signup_categories"]:checked');
        data.allowed_signup_categories = Array.from(categoryCheckboxes).map(cb => cb.value);

        // Process display columns dropdowns - convert to display names
        const columnMapping = {
            'townhall': 'Townhall Level',
            'name': 'Name',
            'tag': 'Player Tag',
            'hitrate': '30 Day Hitrate',
            'current_clan_tag': 'Clan Tag',
            'discord': 'Discord User',
            'hero_lvs': 'Heroes',
            'war_pref': 'War Opt Status',
            'trophies': 'Trophies'
        };
        
        data.columns = [];
        for (let i = 1; i <= 4; i++) {
            const columnField = e.target.elements[`column-${i}`]?.value;
            if (columnField && columnField.trim() !== '') {
                data.columns.push(columnMapping[columnField] || columnField);
            }
        }

        // Process sort configuration - convert to display names
        const sortMapping = {
            'name': 'Name',
            'tag': 'Player Tag',
            'townhall': 'Townhall Level',
            'hero_lvs': 'Heroes',
            'trophies': 'Trophies',
            'hitrate': '30 Day Hitrate',
            'current_clan_tag': 'Clan Tag',
            'added_at': 'Date Added'
        };
        
        data.sort = [];
        for (let i = 1; i <= 4; i++) {
            const sortField = e.target.elements[`sort-${i}`]?.value;
            if (sortField && sortField.trim() !== '') {
                data.sort.push(sortMapping[sortField] || sortField);
            }
        }

        // Clean data
        ['min_th', 'max_th', 'clan_tag', 'max_accounts_per_user', 'roster_size', 'group_id'].forEach(field => {
            if (data[field] === '') data[field] = null;
        });

        // Validate
        if (data.roster_type === 'clan' && !data.clan_tag) {
            showAlert('Clan selection is required for clan-specific rosters', 'error');
            return;
        }

        if (data.min_th && data.max_th && parseInt(data.min_th) > parseInt(data.max_th)) {
            showAlert('Minimum TH cannot be greater than Maximum TH', 'error');
            return;
        }

        try {
            await apiCall(`${API_BASE}/roster/${currentRosterId}?server_id=${serverId}`, 'PATCH', data);
            showAlert('Settings updated successfully!');
        } catch (error) {
            showAlert('Failed to update settings', 'error');
        }
    });


    document.getElementById('create-group-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        try {
            await apiCall(`${API_BASE}/roster-group?server_id=${serverId}`, 'POST', data);
            showAlert('Group created successfully!');
            closeModals();
            location.reload();
        } catch (error) {
            showAlert('Failed to create group', 'error');
        }
    });

    document.getElementById('create-category-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.server_id = serverId;

        // Remove custom_id field if it exists - let API generate it
        delete data.custom_id;

        try {
            await apiCall(`${API_BASE}/roster-signup-category?server_id=${serverId}`, 'POST', data);
            showAlert('Category created successfully!');
            closeModals();

            // Refresh categories list dynamically
            await refreshCategoriesList();

            // Reset form
            e.target.reset();
        } catch (error) {
            showAlert('Failed to create category', 'error');
        }
    });

    document.getElementById('create-roster-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        // Clean clan_tag if empty
        if (data.clan_tag === '') {
            data.clan_tag = null;
        }

        // Validate clan requirement for clan-specific rosters
        if (data.roster_type === 'clan' && !data.clan_tag) {
            showAlert('Clan selection is required for clan-specific rosters', 'error');
            return;
        }

        try {
            await apiCall(`${API_BASE}/roster?server_id=${serverId}`, 'POST', data);
            showAlert('Roster created successfully!');
            closeModals();
            location.reload();
        } catch (error) {
            showAlert('Failed to create roster', 'error');
        }
    });

    // Actions
    async function removeMember(playerTag) {
        if (!confirm('Remove this member from the roster?')) return;

        try {
            await apiCall(`${API_BASE}/roster/${currentRosterId}/members?server_id=${serverId}`, 'POST', {
                remove: [playerTag]
            });
            showAlert('Member removed successfully!');
            await loadMembersDisplay();
        } catch (error) {
            showAlert('Failed to remove member', 'error');
        }
    }

    async function refreshMembers() {
        if (!currentRosterId) {
            showAlert('Please select a roster first', 'error');
            return;
        }

        try {
            showAlert('Refreshing member data...');
            await apiCall(`${API_BASE}/roster/${currentRosterId}/refresh`, 'POST');
            showAlert('Member data refreshed successfully!');
            location.reload();
        } catch (error) {
            showAlert('Failed to refresh member data', 'error');
        }
    }

    async function deleteGroup(groupId) {
        if (!confirm('Delete this group? This cannot be undone.')) return;

        try {
            await apiCall(`${API_BASE}/roster-group/${groupId}?server_id=${serverId}`, 'DELETE');
            showAlert('Group deleted successfully!');
            location.reload();
        } catch (error) {
            showAlert('Failed to delete group', 'error');
        }
    }

    async function deleteCategory(customId) {
        if (!confirm('Delete this category? This cannot be undone.')) return;

        try {
            await apiCall(`${API_BASE}/roster-signup-category/${customId}?server_id=${serverId}`, 'DELETE');
            showAlert('Category deleted successfully!');
            location.reload();
        } catch (error) {
            showAlert('Failed to delete category', 'error');
        }
    }

    // ============= MEMBER SEARCH AND AUTOCOMPLETE =============

    let clanMembers = [];
    let searchTimeout;

    // Populate category dropdown (defensive function)
    function populateCategoryDropdown() {
        const categoryDropdown = document.getElementById('category-selector');
        if (!categoryDropdown)
        {
            console.warn('Category dropdown not found!');
            return;
        }
        
        // Check if dropdown needs populating by comparing expected vs actual option count
        const currentOptionCount = categoryDropdown.children.length;
        const expectedOptionCount = categoriesData ? categoriesData.length + 1 : 1; // +1 for "No category"
        const needsPopulating = categoriesData && categoriesData.length > 0 && currentOptionCount !== expectedOptionCount;
        
        if (needsPopulating) {
            console.log(`Populating category dropdown. Current: ${currentOptionCount}, Expected: ${expectedOptionCount}`);
            let options = '<option value="">No category</option>';
            categoriesData.forEach(category => {
                options += `<option value="${category.custom_id}">${category.alias}</option>`;
            });
            categoryDropdown.innerHTML = options;
        }
    }

    // Load clan members for autocomplete
    async function loadClanMembers() {
        try {
            const response = await apiCall(`${API_BASE}/roster/server/${serverId}/members`, 'GET');
            clanMembers = response.members || [];
        } catch (error) {
            console.error('Failed to load clan members:', error);
        }
    }

    // Search members for autocomplete
    function searchMembers(query) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const suggestions = document.getElementById('member-suggestions');

            if (!query || query.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }

            // Get list of already added member tags to exclude them
            const existingMemberTags = new Set();
            if (currentRosterData && currentRosterData.members) {
                currentRosterData.members.forEach(member => {
                    existingMemberTags.add(member.tag.toLowerCase());
                });
            }

            const matches = clanMembers.filter(member => {
                // Exclude members already in the roster
                if (existingMemberTags.has(member.tag.toLowerCase())) {
                    return false;
                }
                
                // Filter by query
                return member.name.toLowerCase().includes(query.toLowerCase()) ||
                       member.tag.toLowerCase().includes(query.toLowerCase());
            }).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }

            suggestions.innerHTML = matches.map(member => `
                <div class="autocomplete-item flex items-center gap-3" onclick="selectMember('${member.tag}', '${member.name.replace("'", "\\'")}')">
                    <div class="flex-1">
                        <div class="font-medium">${member.name}</div>
                        <div class="text-xs text-muted-foreground">${member.tag} • TH${member.townhall} • ${member.clan_name}</div>
                    </div>
                    <div class="px-2 py-1 bg-primary/10 text-primary rounded text-xs">TH${member.townhall}</div>
                </div>
            `).join('');

            suggestions.classList.remove('hidden');
        }, 300);
    }

    // Select member from autocomplete
    function selectMember(tag, name) {
        document.getElementById('member-search').value = `${name} (${tag})`;
        document.getElementById('member-suggestions').classList.add('hidden');
        // Don't add immediately, just populate the search field
    }

    // Handle Enter key in search
    function handleSearchKeypress(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            addMemberDirectly();
        }
    }

    // Add selected members to pending list
    function addSelectedMembersToList() {
        const input = document.getElementById('member-search');
        const categorySelect = document.getElementById('category-selector');
        let searchValue = input.value.trim();

        if (!searchValue) {
            showAlert('Please enter a player name or tag', 'error');
            return;
        }

        // Extract tag and name if format is "Name (Tag)"
        const tagMatch = searchValue.match(/^(.+?)\s*\((#[A-Z0-9]+)\)$/);
        let playerTag, playerName;

        if (tagMatch) {
            playerName = tagMatch[1];
            playerTag = tagMatch[2];
        } else {
            playerTag = searchValue.startsWith('#') ? searchValue : `#${searchValue.toUpperCase()}`;
            playerName = searchValue;
        }

        // Check if already in pending list
        if (pendingMembers.some(m => m.tag === playerTag)) {
            showAlert('Player already in the pending list', 'error');
            return;
        }

        // Get selected category
        const selectedCategory = categorySelect.value || null;
        const categoryName = categorySelect.selectedOptions[0].text;

        // Find member details from clan members if available
        const clanMember = clanMembers.find(m => m.tag === playerTag);
        const memberData = {
            tag: playerTag,
            name: clanMember ? clanMember.name : playerName,
            townhall: clanMember ? clanMember.townhall : '?',
            clan_name: clanMember ? clanMember.clan_name : 'External',
            signup_group: selectedCategory,
            category_name: selectedCategory ? categoryName : 'No category',
            is_in_family: !!clanMember
        };

        // Add to pending list
        pendingMembers.push(memberData);

        // Clear input
        input.value = '';

        // Update UI
        updatePendingMembersList();
        showAlert(`Added ${memberData.name} to pending list`, 'info');
    }

    // Update pending members display
    function updatePendingMembersList() {
        const container = document.getElementById('pending-members-container');
        const list = document.getElementById('pending-members-list');
        const count = document.getElementById('pending-count');

        if (pendingMembers.length === 0) {
            container.classList.add('hidden');
            return;
        }

        container.classList.remove('hidden');
        count.textContent = `${pendingMembers.length} member${pendingMembers.length > 1 ? 's' : ''} selected`;

        list.innerHTML = pendingMembers.map((member, index) => {
            const familyBadge = member.is_in_family ? '' : ' <span class="text-xs bg-yellow-500/10 text-yellow-600 px-1 py-0.5 rounded">Ext</span>';
            return `
                <div class="flex items-center gap-2 bg-background border border-border rounded px-3 py-2 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="font-medium">${member.name}</span>
                        <span class="text-muted-foreground">${member.tag}</span>
                        <span class="px-2 py-1 bg-primary/10 text-primary rounded text-xs">TH${member.townhall}</span>
                        ${familyBadge}
                    </div>
                    <div class="text-xs text-muted-foreground">→ ${member.category_name}</div>
                    <button onclick="removePendingMember(${index})" 
                            class="w-4 h-4 flex items-center justify-center rounded-full bg-destructive/10 text-destructive hover:bg-destructive/20 transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `;
        }).join('');

        // Recreate icons
        lucide.createIcons();
    }

    // Remove member from pending list
    function removePendingMember(index) {
        pendingMembers.splice(index, 1);
        updatePendingMembersList();
    }

    // Clear all pending members
    function clearPendingMembers() {
        pendingMembers = [];
        updatePendingMembersList();
    }

    // Add all pending members to roster
    async function addAllPendingMembers() {
        if (pendingMembers.length === 0) {
            showAlert('No members to add', 'error');
            return;
        }

        if (!currentRosterId) {
            showAlert('Please select a roster first', 'error');
            return;
        }

        try {
            showAlert(`Adding ${pendingMembers.length} members...`, 'info');

            const membersToAdd = pendingMembers.map(member => ({
                tag: member.tag,
                signup_group: member.signup_group
            }));

            await apiCall(`${API_BASE}/roster/${currentRosterId}/members?server_id=${serverId}`, 'POST', {
                add: membersToAdd
            });

            showAlert(`Successfully added ${pendingMembers.length} members!`);

            // Clear pending list and refresh display
            clearPendingMembers();
            await loadMembersDisplay();
        } catch (error) {
            console.error('Error adding pending members:', error);
            const attemptedTags = pendingMembers.map(m => m.tag);
            handleMemberAddError(error, attemptedTags);
        }
    }

    // ============= MEMBER ADDITION =============

    // Add member directly without going through pending list
    async function addMemberDirectly() {
        const input = document.getElementById('member-search');
        const categorySelect = document.getElementById('category-selector');
        let searchValue = input.value.trim();

        if (!searchValue) {
            showAlert('Please enter a player name or tag', 'error');
            return;
        }

        // Extract tag from input
        const tagMatch = searchValue.match(/^(.+?)\s*\((#[A-Z0-9]+)\)$/);
        let playerTag;

        if (tagMatch) {
            playerTag = tagMatch[2];
        } else {
            playerTag = searchValue.startsWith('#') ? searchValue : `#${searchValue.toUpperCase()}`;
        }

        const selectedCategory = categorySelect.value || null;

        try {
            const membersToAdd = [{
                tag: playerTag,
                signup_group: selectedCategory
            }];

            await apiCall(`${API_BASE}/roster/${currentRosterId}/members?server_id=${serverId}`, 'POST', {
                add: membersToAdd
            });

            showAlert(`Successfully added ${playerTag}!`);
            
            // Clear input and refresh display
            input.value = '';
            await loadMembersDisplay();
        } catch (error) {
            console.error('Error adding member:', error);
            handleMemberAddError(error, [playerTag]);
        }
    }

    // Toggle bulk add section
    function toggleBulkAdd() {
        const section = document.getElementById('bulk-add-section');
        const chevron = document.getElementById('bulk-add-chevron');
        
        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            section.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }

    // Validate and count bulk tags
    function validateBulkTags() {
        const textarea = document.getElementById('bulk-tags-input');
        const countSpan = document.getElementById('bulk-tags-count');
        const addButton = document.getElementById('bulk-add-button');
        
        const text = textarea.value.trim();
        if (!text) {
            countSpan.textContent = '0 tags detected';
            addButton.disabled = true;
            return;
        }

        // Extract tags from text - support multiple formats
        const tags = extractTagsFromText(text);
        const validTags = tags.filter(tag => /^#[A-Z0-9]{3,}$/.test(tag));
        
        countSpan.textContent = `${validTags.length} valid tags detected`;
        if (tags.length > validTags.length) {
            countSpan.textContent += ` (${tags.length - validTags.length} invalid)`;
            countSpan.classList.add('text-yellow-600');
        } else {
            countSpan.classList.remove('text-yellow-600');
        }
        
        addButton.disabled = validTags.length === 0;
    }

    // Extract player tags from text
    function extractTagsFromText(text) {
        // Split by common separators and extract tags
        const lines = text.split(/[\n,;\s]+/);
        const tags = [];
        
        for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            
            // Try to extract tag from various formats
            const tagMatch = line.match(/#[A-Z0-9]+/g);
            if (tagMatch) {
                tags.push(...tagMatch);
            } else if (line.match(/^[A-Z0-9]+$/)) {
                // Plain tag without #
                tags.push('#' + line);
            }
        }
        
        // Remove duplicates and normalize
        return [...new Set(tags.map(tag => tag.toUpperCase()))];
    }

    // Clear bulk tags input
    function clearBulkTags() {
        document.getElementById('bulk-tags-input').value = '';
        validateBulkTags();
    }

    // Add all bulk members
    async function addBulkMembers() {
        const textarea = document.getElementById('bulk-tags-input');
        const categorySelect = document.getElementById('category-selector');
        
        const text = textarea.value.trim();
        const tags = extractTagsFromText(text);
        const validTags = tags.filter(tag => /^#[A-Z0-9]{3,}$/.test(tag));
        
        if (validTags.length === 0) {
            showAlert('No valid tags found', 'error');
            return;
        }

        const selectedCategory = categorySelect.value || null;
        
        try {
            const membersToAdd = validTags.map(tag => ({
                tag: tag,
                signup_group: selectedCategory
            }));

            const response = await apiCall(`${API_BASE}/roster/${currentRosterId}/members?server_id=${serverId}`, 'POST', {
                add: membersToAdd
            });

            const successCount = membersToAdd.length;
            showAlert(`Successfully processed ${successCount} members!`);
            
            // Clear input and refresh display
            clearBulkTags();
            toggleBulkAdd(); // Close bulk section
            await loadMembersDisplay();
            
        } catch (error) {
            console.error('Error adding bulk members:', error);
            handleMemberAddError(error, validTags);
        }
    }

    // Handle member addition errors with specific messages
    function handleMemberAddError(error, attemptedTags) {
        let errorMessage = 'Failed to add members. Please try again.';
        
        try {
            if (error.response) {
                const status = error.response.status;
                const detail = error.response.data?.detail || '';
                
                switch (status) {
                    case 400:
                        if (detail.includes('Invalid signup_group')) {
                            errorMessage = 'Invalid category selected. Please choose a valid category.';
                        } else if (detail.includes('not allowed for this roster')) {
                            errorMessage = 'The selected category is not allowed for this roster.';
                        } else {
                            errorMessage = detail || 'Invalid request. Please check your input.';
                        }
                        break;
                        
                    case 422:
                        errorMessage = 'Invalid player tag format. Player tags should be like #ABC123.';
                        break;
                        
                    case 404:
                        if (attemptedTags.length === 1) {
                            errorMessage = `Player ${attemptedTags[0]} was not found. Please check the tag.`;
                        } else {
                            errorMessage = 'Some players were not found. Please check the tags.';
                        }
                        break;
                        
                    default:
                        errorMessage = detail || `Server error (${status}). Please try again.`;
                }
            } else if (error.message) {
                if (error.message.includes('422')) {
                    errorMessage = 'Invalid player tag format or player not found.';
                } else if (error.message.includes('400')) {
                    errorMessage = 'Invalid request. Please check the category and tags.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'One or more players were not found.';
                } else {
                    errorMessage = error.message;
                }
            }
        } catch (parseError) {
            console.error('Error parsing API error:', parseError);
        }
        
        showAlert(errorMessage, 'error');
        
        // For bulk operations, also log the specific tags that failed
        if (attemptedTags.length > 1) {
            console.log('Failed tags:', attemptedTags);
        }
    }

    // ============= DRAG AND DROP =============

    function allowDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.add('drag-over');
    }

    function drop(event, category) {
        event.preventDefault();
        event.currentTarget.classList.remove('drag-over');

        // Convert string "null" back to actual null
        if (category === "null") {
            category = null;
        }

        const memberTag = event.dataTransfer.getData('text/plain');
        const memberCard = document.querySelector(`[data-member-tag="${memberTag}"]`);

        if (memberCard) {
            // Check if we're in table view (member is a tr) or card view (member is a div)
            const isTableView = memberCard.tagName.toLowerCase() === 'tr';
            
            if (isTableView) {
                // In table view, just update the database and reload the view
                updateMemberCategory(memberTag, category);
            } else {
                // Card view logic (original code)
                const targetContainer = category ?
                    document.getElementById(`category-${category}`) :
                    document.getElementById('uncategorized-members');
                
                if (!targetContainer) {
                    console.error('Target container not found! Current view mode might be incorrect.');
                    return;
                }

                targetContainer.appendChild(memberCard);
                
                // Update member category in database
                updateMemberCategory(memberTag, category);

                // Update counts
                updateCategoryCounts();
            }
        }
    }

    // Update member category
    async function updateMemberCategory(memberTag, category) {
        try {
            await apiCall(`${API_BASE}/roster/${currentRosterId}/members/${encodeURIComponent(memberTag)}?server_id=${serverId}`, 'PATCH', {
                signup_group: category
            });
            
            // Reload the members display to reflect the changes
            await loadMembersDisplay();
        } catch (error) {
            showAlert('Failed to update member category', 'error');
            console.error('Error updating member category:', error);
        }
    }

    // Get current display columns from roster configuration or UI
    function getCurrentDisplayColumns() {
        // Try to get from UI first (for real-time preview)
        const columnsFromUI = [];
        for (let i = 1; i <= 4; i++) {
            const select = document.getElementById(`column-${i}`);
            if (select && select.value) {
                columnsFromUI.push(select.value);
            }
        }
        
        // If we have UI values, use them, otherwise use saved data or defaults
        if (columnsFromUI.length > 0) {
            return columnsFromUI;
        }
        
        if (!currentRosterData || !currentRosterData.columns) {
            // Default columns if none configured
            return ['name', 'tag', 'townhall', 'hitrate'];
        }
        
        // Convert display names to values for internal use
        const reverseColumnMapping = {
            'Townhall Level': 'townhall',
            'Name': 'name',
            'Player Tag': 'tag',
            '30 Day Hitrate': 'hitrate',
            'Clan Tag': 'current_clan_tag',
            'Discord User': 'discord',
            'Heroes': 'hero_lvs',
            'War Opt Status': 'war_pref',
            'Trophies': 'trophies'
        };
        
        return currentRosterData.columns.map(col => reverseColumnMapping[col] || col);
    }

    // Get current sort configuration  
    function getCurrentSortConfig() {
        if (!currentRosterData || !currentRosterData.sort) {
            // Default sort configuration (all ascending as requested)
            return ['name', 'tag', 'hero_lvs', 'townhall'];
        }
        
        // Convert display names to values for internal use
        const reverseSortMapping = {
            'Name': 'name',
            'Player Tag': 'tag',
            'Townhall Level': 'townhall',
            'Heroes': 'hero_lvs',
            'Trophies': 'trophies',
            '30 Day Hitrate': 'hitrate',
            'Clan Tag': 'current_clan_tag',
            'Date Added': 'added_at'
        };
        
        return currentRosterData.sort.map(field => reverseSortMapping[field] || field);
    }

    // Handle column selection changes 
    function handleColumnChange(event) {
        // Prevent form submission
        if (event && event.preventDefault) {
            event.preventDefault();
        }
        
        // Update preview immediately
        updateMemberCardsPreview();
        
        // Return false to prevent any form submission
        return false;
    }

    // Update member cards preview based on column selection
    function updateMemberCardsPreview() {
        if (currentRosterId) {
            loadMembersDisplay();
        }
    }

    // Toggle display configuration section
    function toggleDisplayConfig() {
        const content = document.getElementById('display-config-content');
        const chevron = document.getElementById('display-config-chevron');
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }

    // Save display configuration to database
    async function saveDisplayConfiguration() {
        console.log('saveDisplayConfiguration called');
        
        if (!currentRosterId) {
            console.log('No currentRosterId');
            showNotification('Please select a roster first', 'error');
            return;
        }

        // Get column configuration (4 ordered columns) - convert to display names
        const columnMapping = {
            'townhall': 'Townhall Level',
            'name': 'Name',
            'tag': 'Player Tag',
            'hitrate': '30 Day Hitrate',
            'current_clan_tag': 'Clan Tag',
            'discord': 'Discord User',
            'hero_lvs': 'Heroes',
            'war_pref': 'War Opt Status',
            'trophies': 'Trophies'
        };
        
        const selectedColumns = [];
        for (let i = 1; i <= 4; i++) {
            const columnField = document.getElementById(`column-${i}`).value;
            if (columnField && columnField.trim() !== '') {
                selectedColumns.push(columnMapping[columnField] || columnField);
            }
        }
        
        // Get sort configuration (4 priorities, all ascending) - convert to display names
        const sortMapping = {
            'name': 'Name',
            'tag': 'Player Tag',
            'townhall': 'Townhall Level',
            'hero_lvs': 'Heroes',
            'trophies': 'Trophies',
            'hitrate': '30 Day Hitrate',
            'current_clan_tag': 'Clan Tag',
            'added_at': 'Date Added'
        };
        
        const sortConfig = [];
        for (let i = 1; i <= 4; i++) {
            const sortField = document.getElementById(`sort-${i}`).value;
            if (sortField && sortField.trim() !== '') {
                sortConfig.push(sortMapping[sortField] || sortField);
            }
        }

        try {
            const payload = {
                columns: selectedColumns,
                sort: sortConfig
            };

            await apiCall(`${API_BASE}/roster/${currentRosterId}?server_id=${serverId}`, 'PATCH', payload);
            
            // Update local roster data
            if (currentRosterData) {
                currentRosterData.columns = selectedColumns;
                currentRosterData.sort = sortConfig;
            }

            showNotification('Display configuration saved successfully', 'success');
            updateMemberCardsPreview();
        } catch (error) {
            console.error('Failed to save display configuration:', error);
            showNotification('Failed to save display configuration', 'error');
        }
    }

    // Create table headers for member display
    function createTableHeaders() {
        const displayColumns = getCurrentDisplayColumns();
        
        const columnLabels = {
            'townhall': 'TH',
            'name': 'Name',
            'tag': 'Player Tag',
            'hitrate': 'Hit Rate',
            'current_clan_tag': 'Clan Tag',
            'discord': 'Discord',
            'hero_lvs': 'Heroes',
            'war_pref': 'War Status',
            'trophies': 'Trophies'
        };
        
        const headers = displayColumns.map(column => 
            `<th>${columnLabels[column] || column}</th>`
        ).join('');
        
        return `
            <table class="member-table">
                <thead>
                    <tr>
                        ${headers}
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
    }
    
    function createTableFooter() {
        return `
                </tbody>
            </table>
        `;
    }

    // Create member table row with configurable columns
    function createMemberCard(member) {
        const isInFamily = clanMembers.some(cm => cm.tag === member.tag);
        const familyBadge = isInFamily ? '' : '<span class="px-1 py-0.5 bg-yellow-500/10 text-yellow-600 rounded text-xs ml-2">External</span>';
        
        // Get current roster configuration for columns
        const displayColumns = getCurrentDisplayColumns();
        
        // Build column data based on selected columns
        const columnData = [];
        
        displayColumns.forEach(column => {
            let cellContent = '<td class="px-3 py-2 text-xs text-muted-foreground text-center">-</td>';
            
            switch(column) {
                case 'townhall':
                    if (member.townhall !== undefined && member.townhall !== null) {
                        cellContent = `<td class="px-3 py-2 text-xs text-orange-400 font-medium text-center">TH${member.townhall}</td>`;
                    }
                    break;
                case 'name':
                    if (member.name) {
                        cellContent = `<td class="px-3 py-2 text-xs text-white font-medium text-center">${member.name}</td>`;
                    }
                    break;
                case 'tag':
                    if (member.tag) {
                        cellContent = `<td class="px-3 py-2 text-xs text-muted-foreground font-mono text-center">${member.tag}</td>`;
                    }
                    break;
                case 'hitrate':
                    if (member.hitrate !== undefined && member.hitrate !== null) {
                        const hitColor = member.hitrate >= 80 ? 'text-green-400' : member.hitrate >= 60 ? 'text-yellow-400' : 'text-red-400';
                        cellContent = `<td class="px-3 py-2 text-xs ${hitColor} font-medium text-center">${member.hitrate}%</td>`;
                    }
                    break;
                case 'current_clan_tag':
                    if (member.current_clan_tag && member.current_clan_tag !== '#') {
                        cellContent = `<td class="px-3 py-2 text-xs text-cyan-400 font-mono text-center">${member.current_clan_tag}</td>`;
                    }
                    break;
                case 'discord':
                    if (member.discord && member.discord !== 'No User') {
                        cellContent = `<td class="px-3 py-2 text-xs text-blue-400 text-center">@${member.discord.replace(/[<>@!]/g, '')}</td>`;
                    }
                    break;
                case 'hero_lvs':
                    if (member.hero_lvs !== undefined && member.hero_lvs !== null) {
                        cellContent = `<td class="px-3 py-2 text-xs text-purple-400 text-center">${member.hero_lvs}</td>`;
                    }
                    break;
                case 'war_pref':
                    const warStatus = member.war_pref ? '⚔️ In' : '🚫 Out';
                    const warColor = member.war_pref ? 'text-green-400' : 'text-red-400';
                    cellContent = `<td class="px-3 py-2 text-xs ${warColor} text-center">${warStatus}</td>`;
                    break;
                case 'trophies':
                    if (member.trophies !== undefined && member.trophies !== null) {
                        cellContent = `<td class="px-3 py-2 text-xs text-yellow-400 text-center">${member.trophies} 🏆</td>`;
                    }
                    break;
            }
            columnData.push(cellContent);
        });
        
        return `
            <tr class="member-row hover:bg-accent/50 transition-colors border-b border-border" 
                draggable="true" data-member-tag="${member.tag}" 
                ondragstart="dragStart(event)" ondragend="dragEnd(event)">
                ${columnData.join('')}
                <td class="px-3 py-2 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <button onclick="removeMember('${member.tag}')" 
                                class="w-5 h-5 flex items-center justify-center rounded-full bg-destructive/10 text-destructive hover:bg-destructive/20 transition-colors">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    // Create group separator row
    function createGroupSeparator(categoryName, categoryCount) {
        const displayColumns = getCurrentDisplayColumns();
        const totalCols = displayColumns.length + 1; // +1 for actions column
        
        return `
            <tr class="group-separator">
                <td colspan="${totalCols}" class="px-3 py-3 bg-muted/30 border-y border-border">
                    <div class="flex items-center justify-between">
                        <div class="w-16"></div>
                        <h4 class="font-medium text-sm text-center flex-1">${categoryName}</h4>
                        <span class="text-xs text-muted-foreground">${categoryCount} member${categoryCount !== 1 ? 's' : ''}</span>
                    </div>
                </td>
            </tr>
        `;
    }

    // Create empty drop row for categories without members
    function createEmptyDropRow(category) {
        const displayColumns = getCurrentDisplayColumns();
        const totalCols = displayColumns.length + 1; // +1 for actions column
        
        // Handle null category properly for JavaScript
        const categoryParam = category === null || category === 'null' ? 'null' : `'${category}'`;
        
        return `
            <tr class="empty-drop-row drop-zone border-2 border-dashed border-transparent hover:border-primary hover:bg-primary/5 transition-all hidden" 
                ondrop="drop(event, ${categoryParam})" ondragover="allowDrop(event)">
                <td colspan="${totalCols}" class="px-3 py-3 text-center text-muted-foreground text-sm">
                    Drop members here
                </td>
            </tr>
        `;
    }

    // Create roster info display (read-only)
    function createRosterInfoDisplay(roster) {
        const clanInfo = roster.clan_name ? `
            <div class="flex items-center gap-2">
                <img src="${roster.clan_badge || '/static/default-clan.png'}" alt="Clan Badge" class="w-6 h-6 rounded" onerror="this.style.display='none'">
                <span class="font-medium">${roster.clan_name}</span>
                <span class="text-xs text-muted-foreground">${roster.clan_tag || ''}</span>
            </div>
        ` : '<span class="text-muted-foreground">No clan assigned</span>';


        const thRestriction = (roster.min_th !== null && roster.min_th !== undefined) || (roster.max_th !== null && roster.max_th !== undefined) ? 
            (roster.min_th === roster.max_th ? `TH${roster.min_th}` : 
             (roster.min_th !== null && roster.min_th !== undefined) && (roster.max_th !== null && roster.max_th !== undefined) ? `TH${roster.min_th}-${roster.max_th}` :
             (roster.min_th !== null && roster.min_th !== undefined) ? `TH${roster.min_th}+` : `Up to TH${roster.max_th}`) : 'No restriction';

        return `
            <div class="bg-card border border-border rounded-lg">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h3 class="text-lg font-semibold mb-1">${roster.alias}</h3>
                            <p class="text-sm text-muted-foreground">${roster.description || 'No description'}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-muted-foreground mb-1">Roster Type</div>
                            <div class="text-sm capitalize">${roster.roster_type || 'clan'}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <div class="text-xs text-muted-foreground mb-1">Associated Clan</div>
                            ${clanInfo}
                        </div>
                        
                        <div>
                            <div class="text-xs text-muted-foreground mb-1">TH Restriction</div>
                            <div class="font-medium text-orange-400">${thRestriction}</div>
                        </div>
                        
                        <div>
                            <div class="text-xs text-muted-foreground mb-1">Members</div>
                            <div class="font-medium">${roster.members ? roster.members.length : 0}/${roster.roster_size || 'No limit'}</div>
                        </div>
                    </div>

                    ${roster.event_start_time || roster.signup_close_time ? `
                        <div class="mt-4 pt-3 border-t border-border">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                ${roster.event_start_time ? `
                                    <div>
                                        <div class="text-xs text-muted-foreground mb-1">Event Start</div>
                                        <div class="font-medium">${new Date(roster.event_start_time * 1000).toLocaleString()}</div>
                                    </div>
                                ` : ''}
                                ${roster.signup_close_time ? `
                                    <div>
                                        <div class="text-xs text-muted-foreground mb-1">Signup Closes</div>
                                        <div class="font-medium">${new Date(roster.signup_close_time * 1000).toLocaleString()}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function dragStart(event) {
        console.log('=== DRAG START ===');
        console.log('Drag started for:', event.currentTarget.dataset.memberTag);
        console.log('Current element:', event.currentTarget);
        console.log('Event target:', event.target);
        console.log('dataTransfer available:', !!event.dataTransfer);
        console.log('Element draggable:', event.currentTarget.draggable);
        console.log('Element has data-member-tag:', !!event.currentTarget.dataset.memberTag);
        
        // Find which category this member belongs to (simplified)
        const memberTag = event.currentTarget.dataset.memberTag;
        const memberRow = event.currentTarget;
        let categoryText = 'unknown';
        let currentElement = memberRow.previousElementSibling;
        
        // Look backwards to find the group separator  
        while (currentElement) {
            if (currentElement.classList.contains('group-separator')) {
                const categoryNameElement = currentElement.querySelector('h4');
                categoryText = categoryNameElement ? categoryNameElement.textContent.trim() : 'unknown';
                break;
            }
            currentElement = currentElement.previousElementSibling;
        }
        
        console.log('🎯 MEMBER CATEGORY:', categoryText);
        console.log('🎯 MEMBER TAG:', memberTag);
        
        // Find member's position in table
        const allMemberRows = document.querySelectorAll('.member-row');
        const memberIndex = Array.from(allMemberRows).indexOf(event.currentTarget);
        console.log('🎯 MEMBER POSITION:', memberIndex + 1, 'of', allMemberRows.length);
        
        // Try to prevent any default behavior that might cancel drag
        // event.stopPropagation(); // Let's try without this first
        
        try {
            event.dataTransfer.setData('text/plain', event.currentTarget.dataset.memberTag);
            event.dataTransfer.effectAllowed = 'move';
        } catch (e) {
            console.error('Error setting dataTransfer:', e);
            return false;
        }
        
        event.currentTarget.classList.add('dragging');
        // Force CSS styles to make sure they apply
        event.currentTarget.style.opacity = '0.5';
        event.currentTarget.style.transform = 'scale(0.95)';

        // Capture the dragging element reference before setTimeout
        const draggingElement = event.currentTarget;
        
        // Use a small delay to ensure the drag has properly started
        setTimeout(() => {
            // Show all drop zones during drag
            const dropRows = document.querySelectorAll('.empty-drop-row');
            console.log('Found drop rows:', dropRows.length);
            dropRows.forEach((dropRow, index) => {
                console.log(`Drop row ${index}:`, dropRow);
                console.log(`Before: hidden=${dropRow.classList.contains('hidden')}, border-muted=${dropRow.classList.contains('border-muted')}`);
                dropRow.classList.remove('hidden');
                dropRow.classList.add('border-muted'); // Make border visible
                console.log(`After: hidden=${dropRow.classList.contains('hidden')}, border-muted=${dropRow.classList.contains('border-muted')}`);
            });

            // Also debug the dragging element
            console.log('Dragging element classes:', draggingElement.className);

            // Add drag-over class listeners
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        }, 50); // Small delay to ensure drag has started properly
        
        // Alternative approach - also add a dragover listener to the table to make zones visible
        const membersTable = document.getElementById('members-table');
        if (membersTable && !membersTable.dragoverHandlerAdded) {
            membersTable.addEventListener('dragover', function(e) {
                e.preventDefault(); // Allow drop
                // Make sure drop zones are visible during drag
                const dropRows = document.querySelectorAll('.empty-drop-row');
                dropRows.forEach(dropRow => {
                    dropRow.classList.remove('hidden');
                    dropRow.classList.add('border-muted');
                });
            });
            membersTable.dragoverHandlerAdded = true;
        }
    }

    function dragEnd(event) {
        console.log('=== DRAG END ===');
        console.log('Drag ended for:', event.currentTarget.dataset.memberTag);
        console.log('Drop effect:', event.dataTransfer?.dropEffect);
        console.log('Effective allowed:', event.dataTransfer?.effectAllowed);
        
        // Find which category this member belongs to for debugging
        const memberTag = event.currentTarget.dataset.memberTag;
        const memberRow = event.currentTarget;
        let categoryText = 'unknown';
        let currentElement = memberRow.previousElementSibling;
        
        // Look backwards to find the group separator  
        while (currentElement) {
            if (currentElement.classList.contains('group-separator')) {
                const categoryNameElement = currentElement.querySelector('h4');
                categoryText = categoryNameElement ? categoryNameElement.textContent.trim() : 'unknown';
                break;
            }
            currentElement = currentElement.previousElementSibling;
        }
        
        console.log('🎯 DRAG END CATEGORY:', categoryText);
        
        event.currentTarget.classList.remove('dragging');
        // Remove forced CSS styles
        event.currentTarget.style.opacity = '';
        event.currentTarget.style.transform = '';

        // Hide all drop zones after drag
        document.querySelectorAll('.empty-drop-row').forEach(dropRow => {
            dropRow.classList.add('hidden');
            dropRow.classList.remove('border-muted'); // Remove visible border
        });

        // Remove drag-over classes and listeners
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.classList.remove('drag-over');
            zone.removeEventListener('dragenter', handleDragEnter);
            zone.removeEventListener('dragleave', handleDragLeave);
        });
    }

    function handleDragEnter(event) {
        event.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(event) {
        if (!event.currentTarget.contains(event.relatedTarget)) {
            event.currentTarget.classList.remove('drag-over');
        }
    }

    // Load and display members
    async function loadMembersDisplay() {
        if (!currentRosterId) return;

        try {
            const response = await apiCall(`${API_BASE}/roster/${currentRosterId}?server_id=${serverId}`, 'GET');
            const roster = response.roster;
            
            // Update currentRosterData so search suggestions are updated
            currentRosterData = roster;

            if (!roster.members || roster.members.length === 0) {
                const emptyState = document.getElementById('members-empty-state');
                const memberCategories = document.getElementById('member-categories');
                if (emptyState) emptyState.style.display = 'block';
                if (memberCategories) memberCategories.style.display = 'none';
                return;
            }

            const emptyState = document.getElementById('members-empty-state');
            const memberCategories = document.getElementById('member-categories');
            if (emptyState) emptyState.style.display = 'none';
            if (memberCategories) memberCategories.style.display = 'block';

            // Sort members based on configuration (all ascending)
            const sortConfig = getCurrentSortConfig();
            const sortedMembers = [...roster.members].sort((a, b) => {
                for (const field of sortConfig) {
                    if (!field) continue;
                    
                    let valueA = a[field];
                    let valueB = b[field];
                    
                    // Handle null/undefined values
                    if (valueA == null && valueB == null) continue;
                    if (valueA == null) return 1;
                    if (valueB == null) return -1;
                    
                    // Convert to numbers if applicable
                    if (typeof valueA === 'string' && !isNaN(valueA)) valueA = Number(valueA);
                    if (typeof valueB === 'string' && !isNaN(valueB)) valueB = Number(valueB);
                    
                    let comparison = 0;
                    if (valueA < valueB) comparison = -1;
                    else if (valueA > valueB) comparison = 1;
                    
                    if (comparison !== 0) {
                        return comparison; // Always ascending
                    }
                }
                return 0;
            });

            // Group members by category
            const membersByCategory = {};
            
            // Initialize all categories (including empty ones)
            if (categoriesData) {
                categoriesData.forEach(category => {
                    membersByCategory[category.custom_id] = [];
                });
            }
            
            // Always include uncategorized section
            membersByCategory[null] = [];

            // Populate with actual members
            sortedMembers.forEach(member => {
                const category = member.signup_group;
                if (category && membersByCategory[category]) {
                    // Categorized member
                    membersByCategory[category].push(member);
                } else {
                    // Uncategorized member (signup_group is null/undefined or category doesn't exist)
                    membersByCategory[null].push(member);
                }
            });

            // Create a single table with all members grouped by category
            let tableHTML = createTableHeaders();
            
            Object.entries(membersByCategory).forEach(([category, members]) => {
                // Always show category separator (even for empty categories)
                const categoryName = (category && category !== 'null') ? 
                    categoriesData.find(cat => cat.custom_id === category)?.alias || category :
                    'Uncategorized';
                
                const categoryCount = members.length;
                
                // Add group separator row
                tableHTML += createGroupSeparator(categoryName, categoryCount);
                
                // Add member rows for this category
                if (members.length > 0) {
                    tableHTML += members.map(member => createMemberCard(member)).join('');
                }
                
                // Always add empty row for drag and drop target (regardless of existing members)
                tableHTML += createEmptyDropRow(category);
            });
            
            // Close the table
            tableHTML += createTableFooter();
            
            // Hide the old category sections and replace the member categories with our table
            const categorySections = document.getElementById('category-sections');
            if (categorySections) {
                categorySections.style.display = 'none';
            }
            
            const memberCategoriesSection = document.getElementById('member-categories');
            if (memberCategoriesSection) {
                // Create roster info display
                const rosterInfoHTML = createRosterInfoDisplay(roster);
                
                memberCategoriesSection.innerHTML = `
                    <div class="w-full space-y-4">
                        ${rosterInfoHTML}
                        <div class="bg-card border border-border rounded-lg w-full">
                            <div class="p-4 w-full">
                                <div class="w-full overflow-x-auto">
                                    ${tableHTML}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update counts and recreate icons
            updateCategoryCounts();
            lucide.createIcons();

        } catch (error) {
            console.error('Failed to load members:', error);
        }
    }

    // Update category counts
    function updateCategoryCounts() {
        // Count total members by looking at member-row elements
        const memberRows = document.querySelectorAll('.member-row');
        const totalCount = memberRows.length;
        
        // Update total member count
        const totalCounter = document.getElementById('total-member-count') || document.getElementById('uncategorized-count');
        if (totalCounter) {
            totalCounter.textContent = totalCount;
        }

        // Update individual category counts (still needed for hidden sections)
        document.querySelectorAll('.category-count').forEach(counter => {
            const categoryId = counter.id.replace('count-', '');
            const container = document.getElementById(`category-${categoryId}`);
            if (container) {
                counter.textContent = container.children.length;
            }
        });
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', function (event) {
        const searchContainer = document.getElementById('member-search').parentElement;
        if (!searchContainer.contains(event.target)) {
            document.getElementById('member-suggestions').classList.add('hidden');
        }
    });
</script>
</body>
</html>